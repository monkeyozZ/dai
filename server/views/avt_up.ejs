<% include ./components/header.ejs %>
<link href=" global/plugins/fancybox/source/jquery.fancybox.css" rel="stylesheet" type="text/css" />
<link href=" global/plugins/jquery-file-upload/blueimp-gallery/blueimp-gallery.min.css" rel="stylesheet" type="text/css" />
<link href=" global/plugins/jquery-file-upload/css/jquery.fileupload.css" rel="stylesheet" type="text/css" />
<link href=" global/plugins/jquery-file-upload/css/jquery.fileupload-ui.css" rel="stylesheet" type="text/css" />
<link href="/global/plugins/bootstrap-toastr/toastr.min.css" rel="stylesheet" type="text/css" />
<link href=" css/cropper.css" rel="stylesheet" type="text/css" />
<style>
  .before-up{
    width: 327px;
    height: 327px;
    padding: 0px;
    float: left;
    background: #fcfcfc;
    border: 1px solid #e3e3e3;
    display: none;
  }
  .img_box{
    margin-top: 20px;
  }
  .img_box img{
    width: 100%;
  }
  .after-up{
    background: #fcfcfc;
    overflow: hidden;
    width: 100px;
    height: 100px;
    border: 1px solid #e3e3e3;
    float: left;
    margin-left: 100px;
    display: none;
  }
  .fa{
    cursor: pointer;
  }
  .fa.fa-rotate-right{
    float: right;
  }
  .tool{
    margin-top: 40px;
  }
  .tool .fa{
    font-weight: bold;
  }
</style>
<!-- BEGIN CONTENT -->
<div class="page-content-wrapper">
  <!-- BEGIN CONTENT BODY -->
  <div class="page-content">
    <!-- BEGIN PAGE HEAD-->
    <div class="page-head">
      <!-- BEGIN PAGE TITLE -->
      <div class="page-title">
        <h1>更换头像</h1>
      </div>
      <!-- END PAGE TITLE -->
      <!-- BEGIN PAGE TOOLBAR -->
      <div class="page-toolbar">
        <div id="dashboard-report-range" class="pull-right tooltips btn btn-fit-height green" data-placement="top" data-original-title="Change dashboard date range">
          <i class="icon-calendar"></i>&nbsp;
          <span class="thin uppercase hidden-xs"></span>&nbsp;
          <i class="fa fa-angle-down"></i>
        </div>
        <!-- BEGIN THEME PANEL -->
        <div class="btn-group btn-theme-panel">
          <a href="javascript:;" class="btn dropdown-toggle" data-toggle="dropdown">
            <i class="icon-settings"></i>
          </a>
          <div class="dropdown-menu theme-panel pull-right dropdown-custom hold-on-click">
            <div class="row">
              <div class="col-md-4 col-sm-4 col-xs-12">
                <h3>THEME</h3>
                <ul class="theme-colors">
                  <li class="theme-color theme-color-default" data-theme="default">
                    <span class="theme-color-view"></span>
                    <span class="theme-color-name">Dark Header</span>
                  </li>
                  <li class="theme-color theme-color-light active" data-theme="light">
                    <span class="theme-color-view"></span>
                    <span class="theme-color-name">Light Header</span>
                  </li>
                </ul>
              </div>
              <div class="col-md-8 col-sm-8 col-xs-12 seperator">
                <h3>LAYOUT</h3>
                <ul class="theme-settings">
                  <li> Theme Style
                    <select class="layout-style-option form-control input-small input-sm">
                      <option value="square">Square corners</option>
                      <option value="rounded" selected="selected">Rounded corners</option>
                    </select>
                  </li>
                  <li> Layout
                    <select class="layout-option form-control input-small input-sm">
                      <option value="fluid" selected="selected">Fluid</option>
                      <option value="boxed">Boxed</option>
                    </select>
                  </li>
                  <li> Header
                    <select class="page-header-option form-control input-small input-sm">
                      <option value="fixed" selected="selected">Fixed</option>
                      <option value="default">Default</option>
                    </select>
                  </li>
                  <li> Top Dropdowns
                    <select class="page-header-top-dropdown-style-option form-control input-small input-sm">
                      <option value="light">Light</option>
                      <option value="dark" selected="selected">Dark</option>
                    </select>
                  </li>
                  <li> Sidebar Mode
                    <select class="sidebar-option form-control input-small input-sm">
                      <option value="fixed">Fixed</option>
                      <option value="default" selected="selected">Default</option>
                    </select>
                  </li>
                  <li> Sidebar Menu
                    <select class="sidebar-menu-option form-control input-small input-sm">
                      <option value="accordion" selected="selected">Accordion</option>
                      <option value="hover">Hover</option>
                    </select>
                  </li>
                  <li> Sidebar Position
                    <select class="sidebar-pos-option form-control input-small input-sm">
                      <option value="left" selected="selected">Left</option>
                      <option value="right">Right</option>
                    </select>
                  </li>
                  <li> Footer
                    <select class="page-footer-option form-control input-small input-sm">
                      <option value="fixed">Fixed</option>
                      <option value="default" selected="selected">Default</option>
                    </select>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <!-- END THEME PANEL -->
      </div>
      <!-- END PAGE TOOLBAR -->
    </div>
    <!-- END PAGE HEAD-->
    <!-- BEGIN PAGE BREADCRUMB -->
    <ul class="page-breadcrumb breadcrumb">
      <li>
        <a href="/index">Home</a>
        <i class="fa fa-circle"></i>
      </li>
      <li>
        <span class="active">Dashboard</span>
      </li>
    </ul>
    <!-- END PAGE BREADCRUMB -->
    <!-- BEGIN PAGE BASE CONTENT -->
    <!-- BEGIN DASHBOARD STATS 1-->
    <div class="row">
      <div class="col-md-12">
        <form id="fileupload" action="/user_set" method="POST" enctype="multipart/form-data">
          <!-- The fileupload-buttonbar contains buttons to add/delete files and start/cancel the upload -->
          <div class="row fileupload-buttonbar">
            <div class="col-lg-2">
              <!-- The fileinput-button span is used to style the file input field as button -->
              <span class="btn green fileinput-button">
              <i class="fa fa-plus"></i>
              <span> 选择图片 </span>
              <input type="file" id="inputImage">
              </span>
              <button type="button" class="btn blue start img_ok_btn" data-url="/up_img">
                <i class="fa fa-upload"></i>
                <span> 上传 </span>
              </button>
            </div>
          </div>
        </form>
            <!-- The global progress information -->
            <div class="col-lg-12 img_box">
              <div class="before-up">
                <img id="before_img">
                <div class="col-lg-12 tool">
                  <i class="fa fa-rotate-left btn green fileinput-button" onclick="rotateimgleft()">左转</i>
                  <i class="fa fa-rotate-right btn green fileinput-button" onclick="rotateimgright()">右转</i>
                </div>
              </div>
              <div class="after-up">
              </div>
            </div>
      </div>
    </div>
    <div class="clearfix"></div>
    <!-- END DASHBOARD STATS 1-->
  </div>
  <!-- END CONTENT BODY -->
</div>
<!-- END CONTENT -->
  <% include ./components/footer.ejs %>
<script src="javascripts/cropper.min.js" charset="utf-8"></script>
<script src="/global/plugins/bootstrap-toastr/toastr.min.js" type="text/javascript"></script>
<script>
  $(function() {
    'use strict';
    // 初始化
    var $image = $('#before_img');
    $image.cropper({
      aspectRatio: '1',
      autoCropArea:0.8,
      preview: '.after-up'

    });


    // 上传图片
    var $inputImage = $('#inputImage');
    var URL = window.URL || window.webkitURL;
    var blobURL;
    if (URL) {
      $inputImage.change(function () {
        var files = this.files;
        var file;

        if (files && files.length) {
          file = files[0];

          if (/^image\/\w+$/.test(file.type)) {
            blobURL = URL.createObjectURL(file);
            $image.one('built.cropper', function () {
              // Revoke when load complete
              URL.revokeObjectURL(blobURL);
            }).cropper('reset').cropper('replace', blobURL);
            $('.before-up,.after-up').show();
          } else {
            App.alert({ container: $('#alert_container').val(), // alerts parent container
              place: 'append', // append or prepent in container
              type: 'danger', // alert's type
              message: '请选择图片文件', // alert's message
              close: true, // make alert closable
              reset: false, // close all previouse alerts first
              focus: true, // auto scroll to the alert after shown
              closeInSeconds: 6000, // auto close after defined seconds
              icon: 'fa fa-warning' // put icon class before the message
              });
          }
        }
      });
    } else {
      $inputImage.prop('disabled', true).parent().addClass('disabled');
    }

    //绑定上传事件
    $('.img_ok_btn').on('click',function(){
      var img_src=$image.attr("src");
      if(img_src === undefined){
        App.alert({ container: $('#alert_container').val(), // alerts parent container
          place: 'append', // append or prepent in container
          type: 'danger', // alert's type
          message: '没有选择上传的图片', // alert's message
          close: true, // make alert closable
          reset: false, // close all previouse alerts first
          focus: true, // auto scroll to the alert after shown
          closeInSeconds: 6000, // auto close after defined seconds
          icon: 'fa fa-warning' // put icon class before the message
        });
        return false;
      }

      var url=$(this).attr("data-url");
      var canvas=$("#before_img").cropper('getCroppedCanvas');
      var data=canvas.toDataURL(); //转成base64
      $.ajax({
        url:url,
        dataType:'json',
        type: "POST",
        data: {"image":data.toString()},
        success: function(res){
          //console.log(res)
          if(res.status === 0){
            Command: toastr['success']("头像上传成功", "系统通知")
            toastr.options = {
              "closeButton": true,
              "debug": false,
              "positionClass": "toast-top-right",
              "onclick": null,
              "showDuration": "1000",
              "hideDuration": "1000",
              "timeOut": "5000",
              "extendedTimeOut": "1000",
              "showEasing": "swing",
              "hideEasing": "linear",
              "showMethod": "fadeIn",
              "hideMethod": "fadeOut"
            }
            $('.img-circle').attr('src',res.data)
          }

        },
        error: function(err){
          console.log(err)
        }
      });

    });

  });

  function rotateimgright() {
    $("#before_img").cropper('rotate', 90);
  }


  function rotateimgleft() {
    $("#before_img").cropper('rotate', -90);
  }
</script>
